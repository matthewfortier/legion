<script type="text/javascript">
    const { ipcRenderer } = require('electron');
    const fs = require("file-system");
    const FileHound = require('filehound');
    const { FileSniffer, asArray } = require('filesniffer');
    var lineNumber = require('line-number');
    var Glob = require("glob").Glob

    var globs;
    var async = require("async");
    var os = require('os'),
        cpuCount = os.cpus().length;


    function splitArrayIntoChunks(arr, chunkLen) {
        var chunkList = []
        var chunkCount = Math.ceil(arr.length / chunkLen)
        for (var i = 0; i < chunkCount; i++) {
            chunkList.push(arr.splice(0, chunkLen))
        }
        return chunkList
    }

    ipcRenderer.on("bg-query", (event, args) => {
        var dirs = args.directory.split(",");
        var expression = args.query
        if (/^[A-Za-z]+$/.test(args.query)) {
            expression = `*${args.query}*`
        }

        var options = {
            cwd: dirs[0],
            absolute: true
        }

        globs = new Glob(expression, options, (err, matches) => {
            ipcRenderer.send("console-log", matches);
        })

        globs.on("match", (file) => {
            var filename = file.replace(/^.*[\\\/]/, '')
            var path = file;
            var data = fs.readFileSync(file, 'utf8')
            var matches = []

            ipcRenderer.send("cross-component-process", "increment-searched");

            var match = lineNumber(data, new RegExp(args.content))
            if (match.length > 0) {

                matches.push({
                    path: path,
                    file: filename,
                    match: match
                });

                ipcRenderer.send("match", matches);
            }
        })

        globs.on("end", (matches) => {
            ipcRenderer.send("stop-loading");
        })
    })

</script>