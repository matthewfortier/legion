<script type="text/javascript">
    const { ipcRenderer } = require('electron');
    const fs = require("file-system");
    const FileHound = require('filehound');
    const { FileSniffer, asArray } = require('filesniffer');
    var lineNumber = require('line-number');

    var async = require("async");
    var os = require('os'),
        cpuCount = os.cpus().length;


    function splitArrayIntoChunks(arr, chunkLen) {
        var chunkList = []
        var chunkCount = Math.ceil(arr.length / chunkLen)
        for (var i = 0; i < chunkCount; i++) {
            chunkList.push(arr.splice(0, chunkLen))
        }
        return chunkList
    }

    ipcRenderer.on("bg-query", (event, args) => {
        console.log(args.query)
        console.log(args.directory)

        var exts = args.query.split(";");
        console.log(exts);

        const files = FileHound.create()
            .paths(args.directory)
            .ext(exts)
            .find()

        files.then((files) => {

            ipcRenderer.send("cross-component-process", {
                message: "files-searching",
                data: files.length
            });

            if (args.content == null || args.content == "") {

                var objs = [];

                files.forEach((file, index) => {
                    objs.push({
                        filename: file.replace(/^.*[\\\/]/, ''),
                        path: file
                    });
                });

                ipcRenderer.send("cross-component-process", {
                    message: "files-no-content",
                    data: objs
                });

                ipcRenderer.send("cross-component-process", "hide-results-view");

                ipcRenderer.send("stop-loading");
            } else {
                var chunks = splitArrayIntoChunks(files, cpuCount)
                var matchCounter = 0;

                async.every(chunks, function (files, callback) {
                    var matches = [];
                    var paths = [];
                    var filesLength = files.length;
                    files.forEach((file, index) => {
                        var filename = file.replace(/^.*[\\\/]/, '')
                        var path = file;
                        var data = fs.readFileSync(file, 'utf8')

                        ipcRenderer.send("cross-component-process", "increment-searched");

                        var match = lineNumber(data, new RegExp(args.content))
                        if (match.length > 0) {

                            paths.push({
                                filename: filename,
                                path: path
                            });
                            matches.push({
                                path: path,
                                file: filename,
                                match: match
                            });

                            if (paths.length > Math.ceil(filesLength * .05)) {
                                ipcRenderer.send("file", paths);
                                paths = [];
                            }

                            if (matches.length > Math.ceil(filesLength * .05)) {
                                ipcRenderer.send("match", matches);
                                matches = [];
                            }

                            matchCounter++;
                        }
                    })
                    ipcRenderer.send("match", matches);
                    ipcRenderer.send("file", paths);
                    callback(null, true);
                }, function (err, result) {
                    if (result) {
                        ipcRenderer.send("stop-loading");
                        ipcRenderer.send("match-count", matchCounter);
                    }
                });
            }
        })
    })

</script>